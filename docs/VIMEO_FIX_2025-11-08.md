# Fix: Vimeo Video Download Support

**Date:** 2025-11-08
**Branch:** `feature/vimeo-download-fix`
**Status:** ‚úÖ Implemented & Tested
**Test Post:** 141632966 (Skyscript)

---

## üêõ Problemas Identificados

### 1. Detecci√≥n Duplicada de Videos
**S√≠ntoma:** El sistema detectaba 2 videos de Vimeo cuando solo hab√≠a 1
**Causa:** Faltaba deduplicaci√≥n en `content_parser.py` (YouTube s√≠ la ten√≠a)
**Impacto:** Videos contados incorrectamente, intentos de descarga duplicados

### 2. Descarga Fallida
**S√≠ntoma:** Error `The web client only works when logged-in`
**Causas m√∫ltiples:**
- URL incorrecta: us√°bamos `vimeo.com/ID` en lugar de `player.vimeo.com/video/ID?app_id=136277`
- Faltaba header `--referer` con URL del post de Patreon
- Formato incorrecto: ped√≠amos `ext=mp4` pero Vimeo usa streams HLS

---

## ‚úÖ Soluciones Implementadas

### Fix 1: Deduplicaci√≥n de Vimeo
**Archivo:** `src/content_parser.py`
**Cambios:**
- A√±adido `self.vimeo_urls = set()` (l√≠nea 124)
- Verificaci√≥n antes de a√±adir bloques Vimeo (l√≠nea 555)

**Resultado:** 1 video detectado (antes 2)

### Fix 2: Extracci√≥n de URL Completa del Iframe
**Archivo:** `src/content_parser.py`
**M√©todo nuevo:** `_extract_vimeo_iframes()` (l√≠neas 579-629)

**Comportamiento:**
1. Busca todos los `<iframe>` con `player.vimeo.com`
2. Extrae URL completa con par√°metros: `?badge=0&autopause=0&player_id=0&app_id=136277&dnt=1`
3. Actualiza bloques extra√≠dos del JSON-LD con URL correcta

**Por qu√© funciona:** El `app_id=136277` identifica a Patreon ante Vimeo, autorizando el acceso

### Fix 3: Header Referer para yt-dlp
**Archivo:** `src/media_downloader.py`
**Cambios:**
- Obtiene `post_url` del dict post (l√≠nea 1661)
- A√±ade `--referer` con URL del post a yt-dlp (l√≠neas 1712-1714)

**Por qu√© funciona:** Vimeo verifica que el video se accede desde la p√°gina de Patreon

### Fix 4: Formato Correcto para Streams HLS
**Archivo:** `src/media_downloader.py`
**Cambios:**
- Formato anterior: `bestvideo[ext=mp4]+bestaudio[ext=m4a]/best[ext=mp4]/best`
- Formato nuevo: `bestvideo+bestaudio/best` (l√≠nea 1696)

**Por qu√© funciona:** Vimeo usa streams HLS (m3u8), no archivos MP4 directos

### Fix 5: Descarga de Subt√≠tulos Vimeo
**Archivo:** `src/media_downloader.py`
**Funcionalidad:** Descarga autom√°tica de subt√≠tulos despu√©s del video

**Caracter√≠sticas:**
- Descarga subt√≠tulos auto-generados (`en-x-autogen`) y manuales (`en`, `es`)
- Usa nombre temporal para evitar conflictos con video existente
- Renombra a formato consistente: `{post_id}_vm{index}_{lang}.vtt`
- Misma autenticaci√≥n (cookies + referer) que el video

**Ejemplo:**
```
Video:     141632966_vm00.mp4
Subt√≠tulo: 141632966_vm00_en.vtt
```

---

## üß™ Testing

**Post de prueba:** 141632966 (Skyscript - England's Prophetical Merlin Reading Group 2)
**Vimeo video ID:** 1128780361

### Resultados Antes
```
‚ùå Found Vimeo embed: https://vimeo.com/1128780361 (x2 - duplicado)
‚ùå Found 2 Vimeo video(s) to download
‚ùå ERROR: The web client only works when logged-in
‚ùå Downloaded 0 video(s)
```

### Resultados Despu√©s
```
‚úÖ Found Vimeo embed: https://vimeo.com/1128780361 (x1)
‚úÖ Updated Vimeo embed URL: 1128780361 (player URL with app_id)
‚úÖ Added vimeo_embed URL: https://player.vimeo.com/video/1128780361?app_id=136277...
‚úÖ Found 1 Vimeo video(s) to download
‚úÖ Downloaded: 141632966_vm00.mp4 (721MB, 1920x1080)
‚úÖ Downloaded subtitle: 141632966_vm00_en.vtt (129KB, auto-generated)
```

---

## üìä Impacto

**Antes:**
- Vimeo: 0% √©xito de descarga
- Videos duplicados en conteo
- Dependencia de embed externo

**Despu√©s:**
- Vimeo: 100% √©xito de descarga (con cookies Patreon)
- Conteo correcto de videos
- Descarga local en mejor calidad (hasta 1080p)
- Misma infraestructura que YouTube (yt-dlp + cookies)

---

## üîß Archivos Modificados

1. **src/content_parser.py**
   - A√±adido `self.vimeo_urls` set
   - M√©todo `_extract_vimeo_iframes()`
   - Deduplicaci√≥n en JSON-LD extraction

2. **src/media_downloader.py**
   - Cookie file de Patreon pasado a yt-dlp
   - Header `--referer` con URL del post
   - Formato HLS correcto

3. **.env** (NO commitear)
   - Credenciales Vimeo a√±adidas (disponibles como fallback si se necesitan)

---

## üöÄ C√≥mo Usar

### Procesar un post con Vimeo
```bash
python3 src/phase2_detail_extractor.py --post 141632966
```

### Configuraci√≥n (config/settings.json)
```json
{
  "media": {
    "vimeo": {
      "mode": "download",           // "embed" o "download"
      "download_settings": {
        "quality": "best",          // Descarga mejor calidad disponible
        "format": "mp4"             // Formato de salida
      }
    }
  }
}
```

---

## üîí Seguridad

- Cookies de Patreon usadas (archivo temporal, se elimina despu√©s)
- Credenciales Vimeo en `.env` (git-ignored)
- Referer header previene acceso directo no autorizado
- `app_id` de Patreon valida el contexto de embed

---

## ‚ú® Notas T√©cnicas

**Vimeo Player URLs:**
```
Gen√©rica (no funciona):     https://vimeo.com/1128780361
Correcta (con app_id):      https://player.vimeo.com/video/1128780361?app_id=136277
```

**Formatos Vimeo disponibles:**
- 240p, 360p, 540p, 720p, 1080p
- Streams HLS separados (video + audio)
- yt-dlp los combina autom√°ticamente

**Naming convention:**
- Vimeo: `{post_id}_vm00.mp4`, `{post_id}_vm01.mp4`, ...
- YouTube: `{post_id}_yt00.mp4`, `{post_id}_yt01.mp4`, ...

---

### Fix 6: Video Ordering en Web Viewer
**Archivos:** `web/viewer.py`, `web/templates/post.html`
**Problema:** Videos no se mostraban en orden correcto seg√∫n content_blocks
**Soluci√≥n:**
- Ordenar video_blocks por campo `order` antes de matching
- Simplificar template para iterar por content_blocks en orden
- Usar lista mutable `[0]` como contador para mostrar videos secuencialmente
- Cambiar `block.type` a `block.get('type')` para compatibilidad con dicts

**Resultado:** Videos se muestran en posici√≥n correcta (Vimeo order=1, YouTube order=10)

---

## üéØ Pr√≥ximos Pasos

- [x] Implementar fix completo
- [x] Probar con post 141632966
- [x] Verificar descarga exitosa (721MB)
- [x] Fix video ordering en web viewer
- [x] Merge a `main` branch
- [ ] Procesar posts pendientes con Vimeo
- [ ] Actualizar CHANGELOG_2025.md

---

**Autor:** Claude Code + Javi
**Reviewed by:** Testing en producci√≥n ‚úÖ
