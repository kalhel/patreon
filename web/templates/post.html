<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ post.title or post.post_id }} - Extracted Content</title>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}">

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
            margin: 30px auto;
            padding: 20px;
            background: #fafafa;
            color: #2b2b2b;
            font-size: 16px; /* Tama√±o Patreon */
            line-height: 1.7; /* Line-height Patreon */
        }

        .post-header {
            background: #1a1a1a;
            padding: 1.5rem 3rem;
            margin: 0 auto 25px auto;
            border-bottom: 4px solid #000000;
            border-radius: 24px;
            box-shadow: 0 10px 28px rgba(0, 0, 0, 0.15);
            max-width: 850px;
        }

        .post-meta-summary {
            margin-top: 1.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1.5rem;
        }

        .creator-highlight {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .creator-badge {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid rgba(255, 255, 255, 0.35);
            background: rgba(255, 255, 255, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.75rem;
            font-weight: 600;
            color: #ffffff;
            flex-shrink: 0;
        }

        .creator-details {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
        }

        .creator-details .name {
            color: #ffffff;
            font-size: 1.125rem;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .creator-date-label {
            color: rgba(255, 255, 255, 0.65);
            font-size: 0.75rem;
            letter-spacing: 0.3px;
            text-transform: uppercase;
        }

        .meta-icon-group {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .nav-pills {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            padding-right: 1rem;
            border-right: 2px solid rgba(255, 255, 255, 0.15);
        }

        .content-pills {
            display: flex;
            align-items: center;
            gap: 0.6rem;
        }

        .meta-icon-pill {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            background: rgba(255, 255, 255, 0.12);
            color: rgba(255, 255, 255, 0.85);
            padding: 0.45rem 0.75rem;
            border-radius: 999px;
            font-size: 0.8rem;
            font-weight: 600;
            letter-spacing: 0.3px;
            transition: background 0.2s ease, transform 0.2s ease;
            text-decoration: none;
        }

        .meta-icon-pill:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-1px);
        }

        .meta-icon-pill .icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
        }

        .meta-icon-pill .icon svg {
            width: 100%;
            height: 100%;
            fill: currentColor;
        }

        .meta-icon-pill .count {
            font-variant-numeric: tabular-nums;
        }

        .meta-icon-pill:not(.active) {
            opacity: 0.45;
        }

        .meta-icon-pill.active {
            background: rgba(255, 255, 255, 0.2);
            opacity: 1;
        }

        .meta-icon-pill.emoji .icon {
            font-size: 1rem;
        }

        .meta-icon-pill.like .icon svg {
            fill: #ff6b6b;
        }

        @media (max-width: 768px) {
            .post-header {
                padding: 1rem;
            }

            .post-meta-summary {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .meta-icon-group {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
                width: 100%;
            }

            .nav-pills {
                border-right: none;
                border-bottom: 2px solid rgba(255, 255, 255, 0.15);
                padding-right: 0;
                padding-bottom: 0.75rem;
                width: 100%;
                justify-content: flex-start;
            }

            .content-pills {
                flex-wrap: wrap;
                width: 100%;
            }
        }

        .post-content {
            background: white;
            padding: 1rem 3rem 3rem 3rem;
            max-width: 850px;
            margin: 0 auto;
            border-radius: 24px;
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.07);
        }
        .content-block { margin: 25px 0; }

        /* Images */
        .content-block.image img {
            max-width: 100%;
            height: auto;
            display: block;
            border-radius: 16px;
        }

        /* Videos */
        .content-block.video video {
            width: 100%;
            max-width: 100%;
            height: auto;
            border-radius: 16px;
            background: #000;
            display: block;
        }

        /* Compact single-line audio player with white background */
        .audio-player-container {
            display: flex;
            align-items: center;
            gap: 18px;
            padding: 18px 24px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            margin: 20px 0;
            border: 1px solid rgba(0, 0, 0, 0.06);
        }
        .audio-player-container .audio-avatar {
            width: 70px;
            height: 70px;
            border-radius: 14px;
            object-fit: cover;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
        }
        .audio-btn {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            border: none;
            background: #1a1a1a;
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding-left: 3px;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            flex-shrink: 0;
        }
        .audio-btn:hover {
            transform: scale(1.05);
            background: #2b2b2b;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
        }
        .audio-btn:active {
            transform: scale(0.95);
        }
        .audio-player-main {
            flex: 1;
            min-width: 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Waveform container */
        .waveform-wrapper {
            flex: 1;
            min-width: 0;
        }

        .audio-time {
            font-size: 14px;
            color: #666;
            font-family: monospace;
            white-space: nowrap;
            flex-shrink: 0;
            min-width: 95px;
        }
        .audio-speed {
            background: #f5f5f5;
            border: 1px solid #e0e0e0;
            color: #1a1a1a;
            padding: 8px 15px;
            border-radius: 24px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .audio-speed:hover {
            background: #e0e0e0;
            border-color: #c0c0c0;
        }

        /* Collections */
        .collections-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }
        .collection-badge-post {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #ffffff;
            padding: 8px 14px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
            transition: all 0.2s ease;
            text-decoration: none;
            cursor: pointer;
        }
        .collection-badge-post:hover {
            border-color: #1a1a1a;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        }
        .collection-badge-post .collection-image {
            width: 28px;
            height: 28px;
            border-radius: 4px;
            object-fit: cover;
            border: 1px solid #e0e0e0;
            flex-shrink: 0;
        }
        .collection-badge-post:hover .collection-image {
            border-color: #1a1a1a;
        }
        .collection-badge-post .collection-label {
            font-size: 0.8125rem;
            font-weight: 500;
            color: #666666;
            letter-spacing: 0;
        }
        .collection-badge-post:hover .collection-label {
            color: #1a1a1a;
        }

        /* Headings */
        .content-block h1 { font-size: 32px; margin: 20px 0 20px 0; font-weight: 700; }
        .content-block h2 { font-size: 24px; margin: 30px 0 15px 0; font-weight: 600; }
        .content-block h3 { font-size: 20px; margin: 25px 0 12px 0; font-weight: 600; }

        /* Paragraphs - Estilo Patreon */
        .content-block.paragraph p {
            font-size: 16px !important;
            line-height: 1.7 !important;
            margin: 15px 0;
            color: #2b2b2b;
        }

        /* Aplicar a todo el texto de contenido */
        .post-content,
        .post-content p,
        .post-content div,
        .content-block {
            font-size: 16px;
            line-height: 1.7;
        }

        /* Comments */
        .comments-section {
            margin: 25px auto 0 auto;
            padding: 30px 3rem;
            border: 2px solid #e0e0e0;
            border-radius: 24px;
            max-width: 850px;
            background: white;
        }

        .comments-toggle {
            background: #ffffff;
            color: #1a1a1a;
            border: none;
            padding: 1rem 0;
            font-size: 0.875rem;
            font-weight: 600;
            letter-spacing: 1px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            text-align: left;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 0;
        }

        .comments-toggle:hover {
            background: #f5f5f5;
        }

        .comments-toggle .arrow {
            transition: transform 0.3s ease;
            font-size: 1.2rem;
        }

        .comments-toggle.active .arrow {
            transform: rotate(180deg);
        }

        .comments-list {
            display: none;
            padding-top: 2rem;
        }

        .comments-list.show {
            display: block;
        }

        .comment {
            background: #fafafa;
            padding: 1.5rem;
            margin: 1rem 0;
            border: 1px solid #e0e0e0;
            border-left: 3px solid #1a1a1a;
            transition: all 0.2s ease;
            border-radius: 14px;
        }

        .comment:hover {
            background: #ffffff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .comment-author {
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 0.75rem;
            font-size: 0.9375rem;
            letter-spacing: 0.5px;
        }

        .comment-text {
            color: #2b2b2b;
            line-height: 1.7;
            font-size: 0.9375rem;
        }

        .comment-reply {
            margin-left: 3rem;
            border-left-color: #666666;
        }

        /* YouTube */
        .youtube-embed iframe {
            width: 100%;
            height: 450px;
            margin: 20px 0;
            border-radius: 4px;
        }

        /* Tags */
        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 15px 0 25px 0;
        }
        .tag {
            display: inline-block;
            background: #f5f5f5;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            color: #555;
            border: 1px solid #e0e0e0;
            text-decoration: none;
            transition: all 0.2s;
        }

        .tag:hover {
            background: #1a1a1a;
            color: #ffffff;
            border-color: #1a1a1a;
        }

        /* Blockquotes - Estilo Patreon con l√≠nea vertical */
        .content-block.quote {
            margin: 1.5rem 0;
        }

        .content-block.quote blockquote,
        blockquote {
            border-left: 4px solid #1a1a1a !important; /* L√≠nea vertical negra */
            padding-left: 1.5rem !important;
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
            padding-right: 0;
            margin: 1rem 0;
            font-style: normal !important; /* Sin cursiva */
            font-size: 16px !important;
            line-height: 1.7 !important;
            color: #2b2b2b !important;
            background: transparent !important; /* Sin fondo gris */
        }

        /* Aplicar estilos al texto dentro de blockquotes */
        blockquote *,
        .content-block.quote blockquote * {
            font-size: 16px !important;
            line-height: 1.7 !important;
            font-style: normal !important;
        }
    </style>
</head>
<body>
    <div class="post-header">
        <div class="post-meta-summary">
            <div class="creator-highlight">
                {% if creator_avatar %}
                <img src="{{ creator_avatar }}" alt="{{ creator_display_name }}" class="creator-badge" loading="lazy">
                {% else %}
                <div class="creator-badge">{{ creator_display_name[:1]|upper }}</div>
                {% endif %}
                <div class="creator-details">
                    <div class="name">{{ creator_display_name }}</div>
                    {% if published_label %}
                    <div class="creator-date-label" aria-label="Publication date">
                        {{ published_label }}
                    </div>
                    {% endif %}
                </div>
            </div>
            <div class="meta-icon-group">
                <!-- Navigation pills -->
                <div class="nav-pills">
                    <a href="/" class="meta-icon-pill active" title="Volver al inicio">
                        <span class="icon" aria-hidden="true">
                            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
                            </svg>
                        </span>
                    </a>
                    {% if from_collection_id and collection_info %}
                    <a href="/collection/{{ from_creator_id }}/{{ from_collection_id }}" class="meta-icon-pill active" title="Volver a {{ collection_info.collection_name }}">
                        <span class="icon" aria-hidden="true">
                            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M18.785 16.895c.434 0 .706.055.87.218.162.163.217.434.217.869 0 .434-.055.706-.218.869-.163.163-.434.218-.869.218H5.215c-.435 0-.706-.055-.87-.218-.162-.163-.217-.435-.217-.87 0-.434.055-.705.218-.869.163-.162.434-.217.869-.217zM4.241 5.529c.488-.353 1.462.217 3.41 1.358 2.4 1.407 3.601 2.115 3.602 2.823 0 .708-1.201 1.417-3.603 2.824-1.947 1.141-2.921 1.711-3.409 1.359-.487-.353-.488-1.63-.488-4.183 0-2.552 0-3.828.488-4.181m14.544 6.294c.435 0 .706.054.87.217.162.164.217.435.217.87 0 .434-.055.706-.218.869-.163.163-.434.217-.869.217h-4.722c-.435 0-.707-.054-.87-.217-.163-.163-.217-.435-.217-.87 0-.434.054-.706.217-.869.164-.163.435-.217.87-.217zm0-5.073c.435 0 .706.055.87.218.162.163.217.435.217.87 0 .434-.055.705-.218.868-.163.163-.434.218-.869.218h-2.898c-.435 0-.706-.055-.87-.218-.162-.163-.217-.434-.217-.869 0-.434.054-.706.218-.869.163-.163.434-.218.869-.218z"/>
                            </svg>
                        </span>
                    </a>
                    {% endif %}
                    <a href="https://www.patreon.com/posts/{{ post.post_id }}" target="_blank" rel="noopener" class="meta-icon-pill active" title="Ver post original en Patreon">
                        <span class="icon" aria-hidden="true">
                            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M19 19H5V5h7V3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"/>
                            </svg>
                        </span>
                    </a>
                </div>

                <!-- Content pills -->
                <div class="content-pills">
                    <div class="meta-icon-pill {% if has_images %}active{% endif %}" title="{{ image_count }} im√°genes">
                        <span class="icon" aria-hidden="true">
                            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                            </svg>
                        </span>
                        <span class="count">{{ image_count }}</span>
                    </div>
                    <div class="meta-icon-pill {% if has_videos %}active{% endif %}" title="{{ video_count }} videos">
                        <span class="icon" aria-hidden="true">
                            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/>
                            </svg>
                        </span>
                        <span class="count">{{ video_count }}</span>
                    </div>
                    <div class="meta-icon-pill {% if has_audio %}active{% endif %}" title="{{ audio_count }} audios">
                        <span class="icon" aria-hidden="true">
                            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                            </svg>
                        </span>
                        <span class="count">{{ audio_count }}</span>
                    </div>
                    <div class="meta-icon-pill emoji {% if comments_count %}active{% endif %}" title="{{ comments_count }} comentarios">
                        <span class="icon" aria-hidden="true">üí¨</span>
                        <span class="count">{{ comments_count }}</span>
                    </div>
                    <div class="meta-icon-pill like active" title="{{ likes_count }} likes">
                        <span class="icon" aria-hidden="true">
                            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                            </svg>
                        </span>
                        <span class="count">{{ likes_count }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

            <!-- Content blocks -->
            <div class="post-content">
                {# Show title from post.title if available (always show before content_blocks) #}
                {% if post.title %}
                    <div class="content-block heading-1">
                        <h1>{{ post.title }}</h1>
                    </div>
                {% endif %}

                {# Show collections after title #}
                {% if post.collections and post.collections|length > 0 %}
                    <div class="collections-container">
                        {% for collection in post.collections %}
                            <a href="/collection/{{ post.creator_id }}/{{ collection.collection_id }}" class="collection-badge-post">
                                {% if collection.collection_image_local %}
                                    <img src="{{ url_for('media_file', filename=collection.collection_image_local) }}" alt="{{ collection.collection_name }}" class="collection-image" loading="lazy">
                                {% endif %}
                                <span class="collection-label">{{ collection.collection_name }}</span>
                            </a>
                        {% endfor %}
                    </div>
                {% endif %}

                {# Show tags after collections #}
                {% if post.patreon_tags %}
                    <div class="tags-container">
                        {% for tag in post.patreon_tags %}
                        <a href="/tag/{{ tag }}" class="tag">{{ tag }}</a>
                        {% endfor %}
                    </div>
                {% endif %}

                {# Show audio from local files #}
                {% set local_audios = post.audio_local_paths if post.audio_local_paths is defined and post.audio_local_paths else [] %}
                {% if local_audios %}
                    {% for audio_path in local_audios %}
                        <div class="audio-player-container">
                            {# Use collection image if post belongs to a collection, otherwise use creator avatar #}
                            {% if post.collections and post.collections|length > 0 and post.collections[0].collection_image_local %}
                                <img src="{{ url_for('media_file', filename=post.collections[0].collection_image_local) }}" alt="{{ post.collections[0].collection_name }}" class="audio-avatar" loading="lazy">
                            {% elif creator_avatar %}
                                <img src="{{ creator_avatar }}" alt="Audio thumbnail" class="audio-avatar" loading="lazy">
                            {% endif %}
                            <div class="audio-player-main">
                                <button class="audio-btn" onclick="playPause({{ loop.index }})">‚ñ∂</button>
                                <div id="waveform-{{ loop.index }}"
                                     data-audio-src="{{ url_for('media_file', filename=audio_path) }}"
                                     data-waveform-src="{{ url_for('media_file', filename=audio_path|replace('.mp3', '.json')) }}"
                                     style="flex: 1; min-width: 0;"></div>
                                <span class="audio-time" id="time-{{ loop.index }}">0:00 / 0:00</span>
                                <button class="audio-speed" onclick="changeSpeed({{ loop.index }})">1x</button>
                            </div>
                        </div>
                    {% endfor %}
                {% endif %}

                {# Show videos from local files #}
                {% set local_videos = post.video_local_paths if post.video_local_paths is defined and post.video_local_paths else [] %}
                {% set local_subtitles = post.video_subtitles_relative if post.video_subtitles_relative is defined and post.video_subtitles_relative else [] %}
                {% if local_videos %}
                    {% set primary_video = local_videos[0] %}
                    <div class="content-block video">
                        <video controls preload="metadata" crossorigin="anonymous" id="main-video">
                            <source src="{{ url_for('media_file', filename=primary_video) }}#t=0.1" type="video/mp4">
                            {% if local_subtitles and local_subtitles|length > 0 %}
                                <track kind="subtitles" src="{{ url_for('media_file', filename=local_subtitles[0]) }}" default>
                            {% endif %}
                            Your browser does not support the video tag.
                        </video>
                    </div>
                {% endif %}

                {% if post.content_blocks %}
                    {# Now iterate through content_blocks for text content #}
                    {% set shown_tags = namespace(value=false) %}
                    {% for block in post.content_blocks | sort(attribute='order') %}
                        {% if block.type == 'comments_header' or block.type == 'comment' %}
                            {# Skip comments for now, will show them later #}
                        {% elif block.type == 'heading_1' %}
                            {# Skip heading_1 blocks - already shown from post.title above #}

                        {% elif block.type == 'heading_2' %}
                            <div class="content-block heading-2">
                                <h2>{{ block.text | markdown | safe }}</h2>
                            </div>

                        {% elif block.type == 'heading_3' %}
                            <div class="content-block heading-3">
                                <h3>{{ block.text | markdown | safe }}</h3>
                            </div>

                        {% elif block.type == 'paragraph' %}
                            {% set paragraph_text = (block.text or '') | trim %}
                            {% if paragraph_text and paragraph_text not in date_skip_values and paragraph_text | lower not in date_skip_values_lower %}
                            <div class="content-block paragraph">
                                <p>{{ block.text | markdown | safe }}</p>
                            </div>
                            {% endif %}

                        {% elif block.type == 'image' %}
                            {# Show image using local path if available, otherwise remote URL #}
                            {% if block.media_id %}
                                {# Find local path for this media_id #}
                                {% set local_img = namespace(path='') %}
                                {% for img_path in post.image_local_paths %}
                                    {% if block.media_id in img_path or block.url.split('/')[-2] in img_path %}
                                        {% set local_img.path = img_path %}
                                    {% endif %}
                                {% endfor %}

                                {% if local_img.path %}
                                <div class="content-block image">
                                    <img src="{{ url_for('media_file', filename=local_img.path) }}" alt="{{ block.caption or '' }}" loading="lazy">
                                    {% if block.caption %}
                                    <div class="caption">{{ block.caption }}</div>
                                    {% endif %}
                                </div>
                                {% else %}
                                {# Fallback to remote URL if local not found #}
                                <div class="content-block image">
                                    <img src="{{ block.url }}" alt="{{ block.caption or '' }}" loading="lazy">
                                    {% if block.caption %}
                                    <div class="caption">{{ block.caption }}</div>
                                    {% endif %}
                                </div>
                                {% endif %}
                            {% endif %}

                        {% elif block.type == 'video' %}
                            {# SKIP - Videos se muestran desde video_local_paths m√°s abajo #}

                        {% elif block.type == 'audio' %}
                            {# SKIP - Audios se muestran desde audio_local_paths despu√©s de tags #}

                        {% elif block.type == 'bulleted_list' %}
                            <div class="content-block bulleted-list">
                                <ul>
                                    {% for item in block['items'] %}
                                    <li>{{ item }}</li>
                                    {% endfor %}
                                </ul>
                            </div>

                        {% elif block.type == 'numbered_list' %}
                            <div class="content-block numbered-list">
                                <ol>
                                    {% for item in block['items'] %}
                                    <li>{{ item }}</li>
                                    {% endfor %}
                                </ol>
                            </div>

                        {% elif block.type == 'quote' %}
                            <div class="content-block quote">
                                <blockquote>{{ block.text | markdown | safe }}</blockquote>
                            </div>

                        {% elif block.type == 'youtube_embed' %}
                            <div class="content-block youtube-embed">
                                {% set video_id = block.url.split('v=')[1].split('&')[0] if 'v=' in block.url else block.url.split('/')[-1] %}
                                <iframe
                                    src="https://www.youtube.com/embed/{{ video_id }}"
                                    frameborder="0"
                                    allowfullscreen>
                                </iframe>
                            </div>

                        {% elif block.type == 'iframe' %}
                            <div class="content-block iframe-embed">
                                <iframe src="{{ block.url }}" frameborder="0" allowfullscreen></iframe>
                            </div>

                        {% endif %}
                    {% endfor %}

                    {# Check if content_blocks has any image blocks #}
                    {% set has_image_blocks = post.content_blocks | selectattr('type', 'equalto', 'image') | list | length > 0 %}

                    {# If no image blocks found but we have local images, show them at the end #}
                    {% if not has_image_blocks and post.image_local_paths %}
                        {% for img_path in post.image_local_paths %}
                            <div class="content-block image">
                                <img src="{{ url_for('media_file', filename=img_path) }}" alt="Post image" loading="lazy">
                            </div>
                        {% endfor %}
                    {% endif %}

                {% else %}
                    <!-- Fallback for old format without blocks -->
                    {% if post.full_content %}
                    <div class="content-block paragraph">
                        <p>{{ post.full_content }}</p>
                    </div>
                    {% endif %}

                    {# Show downloaded images (local paths) if available, otherwise show remote URLs #}
                    {% if post.image_local_paths %}
                        {% for img_path in post.image_local_paths %}
                        <div class="content-block image">
                            <img src="{{ url_for('media_file', filename=img_path) }}" alt="Post image" loading="lazy">
                        </div>
                        {% endfor %}
                    {% elif post.images %}
                        {# Fallback to remote URLs (may have expired tokens) #}
                        {% for img_url in post.images %}
                        <div class="content-block image">
                            <img src="{{ img_url }}" alt="Post image" loading="lazy">
                        </div>
                        {% endfor %}
                    {% endif %}


                    {% if post.audios %}
                        {% for audio_url in post.audios %}
                        <div class="content-block audio">
                            <audio controls>
                                <source src="{{ audio_url }}">
                            </audio>
                        </div>
                        {% endfor %}
                    {% endif %}
                {% endif %}
            </div>

            <!-- Comments section - second pass -->
            {% if post.content_blocks %}
                {% set has_comments = post.content_blocks | selectattr('type', 'equalto', 'comment') | list | length > 0 %}
                {% if has_comments %}
                    <div class="comments-section">
                        {% for block in post.content_blocks | sort(attribute='order') %}
                            {% if block.type == 'comments_header' %}
                                <button class="comments-toggle" id="commentsToggle">
                                    <span>{{ block.text }}</span>
                                    <span class="arrow">‚ñº</span>
                                </button>
                            {% endif %}
                        {% endfor %}

                        <div class="comments-list" id="commentsList">
                            {% for block in post.content_blocks | sort(attribute='order') %}
                                {% if block.type == 'comment' %}
                                    <div class="comment {% if block.get('level', 0) > 0 %}comment-reply{% endif %}">
                                        <div class="comment-author">
                                            {{ block.author }}
                                            {% if block.get('level', 0) > 0 %}
                                                <span style="color: #999; font-weight: normal; font-size: 0.8125rem;"> ‚Ü≥ replied</span>
                                            {% endif %}
                                        </div>
                                        <div class="comment-text">{{ block.text | markdown | safe }}</div>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
            {% endif %}
        </div>
    </div>

    <!-- WaveSurfer JS -->
    <script src="https://unpkg.com/wavesurfer.js@7"></script>

    <script>
        // WaveSurfer instances
        const wavesurfers = {};
        const speeds = {};

        // Initialize WaveSurfer for each audio
        document.addEventListener('DOMContentLoaded', function() {
            const waveformDivs = document.querySelectorAll('[id^="waveform-"]');

            waveformDivs.forEach(async (div) => {
                const id = div.id.replace('waveform-', '');
                const audioSrc = div.getAttribute('data-audio-src');
                const waveformSrc = div.getAttribute('data-waveform-src');

                // Try to load pre-generated waveform JSON first
                let waveformData = null;
                try {
                    const response = await fetch(waveformSrc);
                    if (response.ok) {
                        waveformData = await response.json();
                        console.log('‚úì Loaded waveform from JSON:', waveformSrc);
                    }
                } catch (e) {
                    console.log('‚ö† No waveform JSON - waveform will load on first play');
                }

                // Only create WaveSurfer if we have waveform data
                if (waveformData && waveformData.data) {
                    // Create WaveSurfer with pre-generated waveform
                    const config = {
                        container: '#waveform-' + id,
                        waveColor: '#e0e0e0',
                        progressColor: '#1a1a1a',
                        cursorColor: '#1a1a1a',
                        barWidth: 3,
                        barRadius: 3,
                        cursorWidth: 2,
                        height: 70,
                        barGap: 3,
                        normalize: true,
                        backend: 'MediaElement',
                        peaks: [waveformData.data],
                        duration: waveformData.length / waveformData.sample_rate
                    };

                    wavesurfers[id] = WaveSurfer.create(config);
                    speeds[id] = 1;

                    // Store that audio needs to be loaded on play
                    wavesurfers[id]._audioLoaded = false;
                    wavesurfers[id]._audioSrc = audioSrc;

                    // When audio is ready, update the duration
                    wavesurfers[id].on('ready', () => {
                        const duration = wavesurfers[id].getDuration();
                        document.getElementById('time-' + id).textContent =
                            '0:00 / ' + formatTime(duration);
                    });

                    // Update time display
                    wavesurfers[id].on('timeupdate', (currentTime) => {
                        const duration = wavesurfers[id].getDuration();
                        document.getElementById('time-' + id).textContent =
                            formatTime(currentTime) + ' / ' + formatTime(duration);
                    });

                    // Update button when playback ends
                    wavesurfers[id].on('finish', () => {
                        const btn = document.querySelector(`button[onclick="playPause(${id})"]`);
                        if (btn) btn.textContent = '‚ñ∂';
                    });
                } else {
                    // No JSON - don't create WaveSurfer yet, will create on first play
                    wavesurfers[id] = null;
                    speeds[id] = 1;

                    // Show placeholder in waveform container
                    const container = document.getElementById('waveform-' + id);
                    container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 70px; color: #999; font-size: 13px;">‚ö†Ô∏è Waveform se generar√° al reproducir</div>';
                    container._audioSrc = audioSrc;
                    container._needsInit = true;
                }
            });
        });

        function formatTime(seconds) {
            if (seconds >= 3600) {
                // Format as H:MM:SS for durations >= 1 hour
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const secs = Math.floor(seconds % 60);
                return hours + ':' + (minutes < 10 ? '0' : '') + minutes + ':' + (secs < 10 ? '0' : '') + secs;
            } else {
                // Format as MM:SS for durations < 1 hour
                const minutes = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return minutes + ':' + (secs < 10 ? '0' : '') + secs;
            }
        }

        function playPause(id) {
            const button = event.target;
            const ws = wavesurfers[id];

            // If WaveSurfer doesn't exist yet (no JSON waveform), create it now
            if (!ws) {
                const container = document.getElementById('waveform-' + id);
                if (container._needsInit) {
                    button.textContent = '‚è≥';
                    button.disabled = true;
                    container.innerHTML = ''; // Clear placeholder

                    // Create WaveSurfer with audio URL (will generate waveform)
                    wavesurfers[id] = WaveSurfer.create({
                        container: '#waveform-' + id,
                        waveColor: '#e0e0e0',
                        progressColor: '#1a1a1a',
                        cursorColor: '#1a1a1a',
                        barWidth: 3,
                        barRadius: 3,
                        cursorWidth: 2,
                        height: 70,
                        barGap: 3,
                        normalize: true,
                        backend: 'MediaElement',
                        url: container._audioSrc
                    });

                    wavesurfers[id].on('ready', () => {
                        wavesurfers[id].play();
                        button.textContent = '‚è∏';
                        button.disabled = false;

                        const duration = wavesurfers[id].getDuration();
                        document.getElementById('time-' + id).textContent = '0:00 / ' + formatTime(duration);
                    });

                    // Setup time updates
                    wavesurfers[id].on('timeupdate', (currentTime) => {
                        const duration = wavesurfers[id].getDuration();
                        document.getElementById('time-' + id).textContent = formatTime(currentTime) + ' / ' + formatTime(duration);
                    });

                    wavesurfers[id].on('finish', () => {
                        button.textContent = '‚ñ∂';
                    });
                }
                return;
            }

            if (ws.isPlaying()) {
                ws.pause();
                button.textContent = '‚ñ∂';
            } else {
                // If audio hasn't been loaded yet (using JSON peaks), load it now
                if (!ws._audioLoaded && ws._audioSrc) {
                    button.textContent = '‚è≥';
                    button.disabled = true;
                    ws.load(ws._audioSrc).then(() => {
                        ws._audioLoaded = true;
                        ws.play();
                        button.textContent = '‚è∏';
                        button.disabled = false;
                    });
                } else {
                    ws.play();
                    button.textContent = '‚è∏';
                }
            }
        }

        function changeSpeed(id) {
            if (!wavesurfers[id]) return; // Can't change speed if not initialized yet

            const button = event.target;
            const speedOptions = [1, 1.25, 1.5, 1.75, 2];
            const currentIndex = speedOptions.indexOf(speeds[id]);
            const nextIndex = (currentIndex + 1) % speedOptions.length;
            const newSpeed = speedOptions[nextIndex];

            wavesurfers[id].setPlaybackRate(newSpeed);
            speeds[id] = newSpeed;
            button.textContent = newSpeed + 'x';
        }

        // Comments toggle
        const commentsToggle = document.getElementById('commentsToggle');
        const commentsList = document.getElementById('commentsList');

        if (commentsToggle && commentsList) {
            commentsToggle.addEventListener('click', function() {
                commentsList.classList.toggle('show');
                commentsToggle.classList.toggle('active');
            });
        }
    </script>
</body>
</html>
